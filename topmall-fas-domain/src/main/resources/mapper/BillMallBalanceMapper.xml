<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="topmall.fas.repository.BillMallBalanceRepository"> 
    <!-- auto generate -->
    
    <resultMap id="baseResultMap" type="topmall.fas.model.BillMallBalance">
           <id column="id" property="id" jdbcType="VARCHAR" />  
           <result column="bill_no" property="billNo" jdbcType="VARCHAR" />  
           <result column="bill_type" property="billType" jdbcType="INTEGER" />  
           <result column="company_no" property="companyNo" jdbcType="VARCHAR" />  
           <result column="shop_no" property="shopNo" jdbcType="VARCHAR" />  
           <result column="mall_no" property="mallNo" jdbcType="VARCHAR" />  
           <result column="business_type" property="businessType" jdbcType="TINYINT" />  
           <result column="area_compact" property="areaCompact" jdbcType="DECIMAL" />  
           <result column="open_date" property="openDate" jdbcType="DATE" />  
           <result column="status" property="status" jdbcType="TINYINT" />  
           <result column="create_time" property="createTime" jdbcType="TIMESTAMP" />  
           <result column="create_user" property="createUser" jdbcType="VARCHAR" />  
           <result column="auditor" property="auditor" jdbcType="VARCHAR" />  
           <result column="audit_time" property="auditTime" jdbcType="TIMESTAMP" />  
           <result column="remark" property="remark" jdbcType="VARCHAR" />  
           <result column="settle_month" property="settleMonth" jdbcType="VARCHAR" />  
           <result column="settle_start_date" property="settleStartDate" jdbcType="DATE" />  
           <result column="settle_end_date" property="settleEndDate" jdbcType="DATE" />  
           <result column="update_time" property="updateTime" jdbcType="TIMESTAMP" />
           <result column="bunk_group_no" property="bunkGroupNo" jdbcType="VARCHAR" /> 
           <result column="pre_billing_amount" property="preBillingAmount" jdbcType="DECIMAL" /> 
           <result column="not_billing_amount" property="notBillingAmount" jdbcType="DECIMAL" /> 
           <result column="pre_able_amount" property="preAbleAmount" jdbcType="DECIMAL" /> 
           <result column="mall_billing_amount" property="mallBillingAmount" jdbcType="DECIMAL" />
           <result column="mall_minimum_amount" property="mallMinimumAmount" jdbcType="DECIMAL" />    
    </resultMap>      
    
    
    <sql id="column_list"> 
        id,bill_no,bill_type,company_no,shop_no,mall_no,business_type,area_compact,open_date,status,create_time,create_user,auditor,audit_time,remark,settle_month,settle_start_date,settle_end_date,update_time,bunk_group_no,
        pre_billing_amount,not_billing_amount,pre_able_amount,mall_billing_amount,mall_minimum_amount
    </sql>

    <sql id="condition">  1=1
    --  and @Shop!shop_no
    	<if test="null!=params">
            <if test="null!=params.queryCondition and ''!=params.queryCondition">
    			And ${params.queryCondition}
    		</if>
    		<if test="null!=params.id and ''!=params.id">
    			And id=#{params.id}
    		</if>
    		<if test="null!=params.billNo and ''!=params.billNo">
    			And bill_no=#{params.billNo}
    		</if>
    		<if test="null!=params.billType and ''!=params.billType">
    			And bill_type=#{params.billType}
    		</if>
    		<if test="null!=params.companyNo and ''!=params.companyNo">
    			And company_no=#{params.companyNo}
    		</if>
    		<if test="null!=params.shopNo and ''!=params.shopNo">
    			And shop_no=#{params.shopNo}
    		</if>
    		<if test="null!=params.mallNo and ''!=params.mallNo">
    			And mall_no=#{params.mallNo}
    		</if>
    		<if test="null!=params.businessType and ''!=params.businessType">
    			And business_type=#{params.businessType}
    		</if>
    		<if test="null!=params.areaCompact and ''!=params.areaCompact">
    			And area_compact=#{params.areaCompact}
    		</if>
    		<if test="null!=params.openDate and ''!=params.openDate">
    			And open_date=#{params.openDate}
    		</if>
    		<if test="null!=params.status and ''!=params.status">
    			And status=#{params.status}
    		</if>
    		<if test="null!=params.createTime and ''!=params.createTime">
    			And create_time=#{params.createTime}
    		</if>
    		<if test="null!=params.createUser and ''!=params.createUser">
    			And create_user=#{params.createUser}
    		</if>
    		<if test="null!=params.auditor and ''!=params.auditor">
    			And auditor=#{params.auditor}
    		</if>
    		<if test="null!=params.auditTime and ''!=params.auditTime">
    			And audit_time=#{params.auditTime}
    		</if>
    		<if test="null!=params.remark and ''!=params.remark">
    			And remark=#{params.remark}
    		</if>
    		<if test="null!=params.settleMonth and ''!=params.settleMonth">
    			And settle_month=#{params.settleMonth}
    		</if>
    		<if test="null!=params.settleStartDate and ''!=params.settleStartDate">
    			And settle_start_date=#{params.settleStartDate}
    		</if>
    		<if test="null!=params.settleEndDate and ''!=params.settleEndDate">
    			And settle_end_date=#{params.settleEndDate}
    		</if>
    		<if test="null!=params.updateTime and ''!=params.updateTime">
    			And update_time=#{params.updateTime}
    		</if>
    		<if test="null!=params.bunkGroupNo and ''!=params.bunkGroupNo">
    			And bunk_group_no=#{params.bunkGroupNo}
    		</if>
        </if>
    </sql>
    
    <sql id="uniqe_condition">   
        1=1  
         <if test="null!=params.billNo and ''!=params.billNo">
    			And bill_no=#{params.billNo}
    	</if>
    </sql>
    
    
    <select id="findByPrimaryKey" resultMap="baseResultMap" > 
		SELECT
		<include refid="column_list" />
		FROM fas_bill_mall_balance
		WHERE id = #{id};
	</select>
    
    <select id="findByUnique" resultMap="baseResultMap" > 
		SELECT
		<include refid="column_list" />
		FROM fas_bill_mall_balance
		WHERE  <include refid="uniqe_condition" />
	</select>
    
    <select id="findByParam" resultMap="baseResultMap" parameterType="map"> 
		SELECT
		<include refid="column_list" />
		FROM fas_bill_mall_balance
		WHERE  <include refid="condition" />
        
	</select>
    
	<select id="selectCount" resultType="java.lang.Integer">
		SELECT COUNT(1) as s FROM fas_bill_mall_balance WHERE 
		<include refid="condition" />
	</select>
    
	<select id="selectByPage" resultMap="baseResultMap" parameterType="map">
		SELECT
		<include refid="column_list" />
		FROM fas_bill_mall_balance WHERE 
		<include refid="condition" />
		<if test="orderby != null and ''!=orderby">
			ORDER BY ${orderby} 
		</if>
		LIMIT #{page.startRowNum} ,#{page.pageSize}
	</select>
    
	<select id="selectByParams" resultMap="baseResultMap" parameterType="map">
		SELECT
		<include refid="column_list" />
		FROM fas_bill_mall_balance WHERE 
		<include refid="condition" /> 
        <if test="orderby != null and ''!=orderby">
			ORDER BY ${orderby}
		</if>
	</select> 
    
    <delete id="deleteByPrimaryKey">
		DELETE FROM fas_bill_mall_balance
		WHERE id = #{id}
	</delete>
    
    <delete id="deleteByUnique">
		DELETE FROM fas_bill_mall_balance
		WHERE <include refid="uniqe_condition" />
	</delete> 
    
	<delete id="deleteByParams" parameterType="map">
		DELETE
		FROM fas_bill_mall_balance
		WHERE 
        <include refid="condition" />
         <if test="params.ids!=null and ''!=params.ids ">
			AND id in ( ${params.ids} )
		</if>
	</delete>
    
    <insert id="insert" parameterType="topmall.fas.model.BillMallBalance"  >
		INSERT INTO fas_bill_mall_balance
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="id != null">
				id,
			</if>
			<if test="billNo != null">
				bill_no,
			</if>
			<if test="billType != null">
				bill_type,
			</if>
			<if test="shopNo != null">
				shop_no,
				company_no,
				open_date,
			</if>
			<if test="mallNo != null">
				mall_no,
			</if>
			<if test="businessType != null">
				business_type,
			</if>
			<if test="areaCompact != null">
				area_compact,
			</if>
			<if test="status != null">
				status,
			</if>
			<if test="createTime != null">
				create_time,
			</if>
			<if test="createUser != null">
				create_user,
			</if>
			<if test="auditor != null">
				auditor,
			</if>
			<if test="auditTime != null">
				audit_time,
			</if>
			<if test="remark != null">
				remark,
			</if>
			<if test="settleMonth != null">
				settle_month,
			</if>
			<if test="settleStartDate != null">
				settle_start_date,
			</if>
			<if test="settleEndDate != null">
				settle_end_date,
			</if>
			<if test="bunkGroupNo != null">
				bunk_group_no,
			</if>
			<if test="preBillingAmount != null">
				pre_billing_amount,
			</if>
			<if test="notBillingAmount != null">
				not_billing_amount,
			</if>
			<if test="preAbleAmount != null">
				pre_able_amount,
			</if>
			<if test="mallBillingAmount != null">
				mall_billing_amount,
			</if>
			<if test="mallMinimumAmount != null">
				mall_minimum_amount,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=","> 
			<if test="id != null">
				 #{id},
			</if>
			<if test="billNo != null">
				 #{billNo},
			</if>
			<if test="billType != null">
				 #{billType},
			</if>
			<if test="shopNo != null">
				 #{shopNo},
				 (select company_no from  mdm_shop where shop_no= #{shopNo}),
				 (select open_date from  mdm_shop where shop_no= #{shopNo}),
			</if>
			<if test="mallNo != null">
				 #{mallNo},
			</if>
			<if test="businessType != null">
				 #{businessType},
			</if>
			<if test="areaCompact != null">
				 #{areaCompact},
			</if>
			<if test="status != null">
				 #{status},
			</if>
			<if test="createTime != null">
				 #{createTime},
			</if>
			<if test="createUser != null">
				 #{createUser},
			</if>
			<if test="auditor != null">
				 #{auditor},
			</if>
			<if test="auditTime != null">
				 #{auditTime},
			</if>
			<if test="remark != null">
				 #{remark},
			</if>
			<if test="settleMonth != null">
				 #{settleMonth},
			</if>
			<if test="settleStartDate != null">
				 #{settleStartDate},
			</if>
			<if test="settleEndDate != null">
				 #{settleEndDate},
			</if>
			<if test="bunkGroupNo != null">
				 #{bunkGroupNo},
			</if>
			<if test="preBillingAmount != null">
				 #{preBillingAmount},
			</if>
			<if test="notBillingAmount != null">
				 #{notBillingAmount},
			</if>
			<if test="preAbleAmount != null">
				 #{preAbleAmount},
			</if>
			<if test="mallBillingAmount != null">
				 #{mallBillingAmount},
			</if>
			<if test="mallMinimumAmount != null">
				 #{mallMinimumAmount},
			</if>
		</trim>
	</insert>
    
    <update id="update" parameterType="topmall.fas.model.BillMallBalance">
		UPDATE fas_bill_mall_balance
		<set>
			<if test="billNo != null">
				bill_no = #{billNo},
			</if>
			<if test="billType != null">
				bill_type = #{billType},
			</if>
			<if test="companyNo != null">
				company_no = #{companyNo},
			</if>
			<if test="shopNo != null">
				shop_no = #{shopNo},
			</if>
			<if test="mallNo != null">
				mall_no = #{mallNo},
			</if>
			<if test="businessType != null">
				business_type = #{businessType},
			</if>
			<if test="areaCompact != null">
				area_compact = #{areaCompact},
			</if>
			<if test="openDate != null">
				open_date = #{openDate},
			</if>
			<if test="status != null">
				status = #{status},
			</if>
			<if test="createTime != null">
				create_time = #{createTime},
			</if>
			<if test="createUser != null">
				create_user = #{createUser},
			</if>
			<if test="auditor != null">
				auditor = #{auditor},
			</if>
			<if test="auditTime != null">
				audit_time = #{auditTime},
			</if>
			<if test="remark != null">
				remark = #{remark},
			</if>
			<if test="settleMonth != null">
				settle_month = #{settleMonth},
			</if>
			<if test="settleStartDate != null">
				settle_start_date = #{settleStartDate},
			</if>
			<if test="settleEndDate != null">
				settle_end_date = #{settleEndDate},
			</if>
			<if test="bunkGroupNo != null">
				bunk_group_no = #{bunkGroupNo},
			</if>
			<if test="preBillingAmount != null">
				 pre_billing_amount = #{preBillingAmount},
			</if>
			<if test="notBillingAmount != null">
				not_billing_amount = #{notBillingAmount},
			</if>
			<if test="preAbleAmount != null">
				 pre_able_amount = #{preAbleAmount},
			</if>
			<if test="mallBillingAmount != null">
				mall_billing_amount = #{mallBillingAmount},
			</if>
			<if test="mallMinimumAmount != null">
			    mall_minimum_amount = #{mallMinimumAmount},
			</if>
		</set>
		WHERE id = #{id}
	</update>
    <!-- auto generate end-->
    
    <select id="proMinimumSum" resultType="java.math.BigDecimal" parameterType="map">
    	SELECT
    		<choose>
    			<when test="params.calculationMethod">
					sum(d.net_income_amount)
				</when>
    			<otherwise>
    				sum(d.pay_amount) 
    			</otherwise>
    		</choose>
		FROM 
			pos_shop_day_sale a  
		INNER JOIN 
			pos_mall_day_sale c on c.bill_no = a.bill_no
		inner join
		    pos_shop_day_sale_dtl d on a.bill_no=d.bill_no
    	where 1=1
    	AND c.mall_minimum_flag=1
    	<if test="null!=params">
            <if test="null!=params.mallNo and ''!=params.mallNo">
    			and c.mall_no =#{params.mallNo}
    		</if>
    		<if test="null!=params.shopNo and ''!=params.shopNo">
    			and a.shop_no =#{params.shopNo}
    		</if>
    		<if test="null!=params.settleStartDate and ''!=params.settleStartDate
    				and null!=params.settleEndDate and ''!=params.settleEndDate">
    			and a.sale_date BETWEEN #{params.settleStartDate} and #{params.settleEndDate}
    		</if>
    		<if test="null!=params.bunkGroupNo and ''!=params.bunkGroupNo">
    		 	And c.bunk_group_no =#{params.bunkGroupNo}
    		</if>
    		<if test="params.pointsCalculateFlag">
    			and d.pay_no!='P60'
    		</if>
    	</if>
    </select>
    
    <select id="yearGuaraSum" resultType="java.math.BigDecimal" parameterType="map">
    SELECT
		b.base_amount
	FROM
	  con_cu_contract_guara b
	WHERE
		b.bill_no=#{params.conBillNo}
	and b.start_date &lt;= #{params.settleStartDate}
	AND b.end_date &gt;= #{params.settleEndDate}
	AND b.base_cycle = 4 limit 1
    </select>
    
    <select id="billingSum" resultType="java.math.BigDecimal" parameterType="map">
    	select 
    		sum(settle_sum)-sum(profit_Amount) 
    	from (
			select 
			<choose>
				<when test="params.pointsCalculateFlag">
				sum(settle_sum-points_amount) settle_sum,
				</when>
				<otherwise>
				sum(settle_sum) settle_sum,
				</otherwise>
			</choose>
				 sum(profit_Amount) profit_Amount 
			from 
				fas_mall_sale_cost
			where 
				balance_bill_no=#{params.balanceBillNo} and bill_debit=1
			union ALL 
			select 0 as settle_sum,sum(able_sum) profit_Amount 
			from 
				fas_mall_cost 
			where 
				balance_bill_no=#{params.balanceBillNo}  and bill_debit=1
		) t
    </select>
        
</mapper>
